name: Auto Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸš€ Auto Deploy to Server
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1ï¸âƒ£ Validate required secrets
      - name: ğŸ§© Validate Secrets
        run: |
          if [ -z "${{ secrets.DEPLOY_KEY }}" ]; then echo "âŒ Missing DEPLOY_KEY"; exit 1; fi
          if [ -z "${{ secrets.DEPLOY_HOST }}" ] || [ -z "${{ secrets.DEPLOY_USER }}" ]; then echo "âŒ Missing DEPLOY_HOST or DEPLOY_USER"; exit 1; fi
          echo "âœ… All required secrets are present"

      # 2ï¸âƒ£ Setup SSH key
      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts
          echo "âœ… SSH configured successfully"

      # 3ï¸âƒ£ Test SSH connection
      - name: ğŸ›°ï¸ Test SSH Connection
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" \
            "echo 'âœ… SSH connection successful on $(hostname)'"

      # 4ï¸âƒ£ Checkout repository
      - name: ğŸ§± Checkout Repository
        uses: actions/checkout@v4

      # 5ï¸âƒ£ Install dependencies
      - name: ğŸ› ï¸ Install Dependencies
        run: npm ci --verbose

      # 6ï¸âƒ£ Build project
      - name: ğŸ§© Build Project
        run: npm run build --if-present --verbose

      # 7ï¸âƒ£ Deploy to remote server using rsync
      - name: ğŸ“¦ Deploy via rsync
        run: |
          echo "ğŸšš Deploying to remote server..."
          rsync -avz --delete --progress \
            -e "ssh -i ~/.ssh/id_rsa" \
            ./ "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/var/www/nursery-system"
          echo "âœ… Deployment completed successfully"

      # 8ï¸âƒ£ Restart or start PM2 process remotely
      - name: âš™ï¸ Restart PM2 Service
        run: |
          echo "â™»ï¸ Restarting PM2 service on remote server..."
          ssh -i ~/.ssh/id_rsa "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" "
            pm2 restart nursery-system || pm2 start /var/www/nursery-system/app.js --name nursery-system;
            pm2 save;
            pm2 list
          "
          echo "âœ… PM2 service restarted successfully"

      # 9ï¸âƒ£ Post-deployment Health Check
      - name: ğŸ§ª Health Check
        run: |
          echo "ğŸ” Running health check on deployed service..."
          ssh -i ~/.ssh/id_rsa "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" "
            curl -fs http://localhost:3000/api/health || (echo 'âŒ Health check failed'; exit 1)
          "
          echo "âœ… Health check passed!"

      # ğŸ”Ÿ Deployment Summary
      - name: ğŸ” Deployment Summary
        run: |
          echo "=== Deployment Summary ==="
          echo "ğŸ“¦ Host: ${{ secrets.DEPLOY_HOST }}"
          echo "ğŸ‘¤ User: ${{ secrets.DEPLOY_USER }}"
          ssh -i ~/.ssh/id_rsa "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" "
            pm2 describe nursery-system || echo 'PM2 process not found'
          "
          echo "=== End Summary ==="