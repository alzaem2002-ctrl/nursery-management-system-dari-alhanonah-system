name: Auto Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    name: 🚀 Auto Deploy to Server
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: 🧩 Validate Secrets
        run: |
          if [ -z "${{ secrets.DEPLOY_KEY }}" ]; then echo "❌ Missing DEPLOY_KEY"; exit 1; fi
          if [ -z "${{ secrets.DEPLOY_HOST }}" ] || [ -z "${{ secrets.DEPLOY_USER }}" ]; then echo "❌ Missing DEPLOY_HOST or DEPLOY_USER"; exit 1; fi
          echo "✅ Secrets validation passed"

      - name: 🔑 Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      - name: 🛰️ Test SSH Connection
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" "echo 'SSH ✅ Connected'"

      - name: 🧱 Checkout Repository
        uses: actions/checkout@v4

      - name: 🛠️ Install Dependencies
        run: npm ci --verbose

      - name: 🧩 Build Project
        run: npm run build --if-present --verbose

      - name: 📦 Deploy via rsync
        run: |
          rsync -avz --delete --progress -e "ssh -i ~/.ssh/id_rsa" ./ "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/var/www/nursery-system"

      - name: ⚙️ Restart PM2 Service
        run: |
          ssh -i ~/.ssh/id_rsa "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" "
            pm2 status;
            pm2 restart nursery-system || pm2 start /var/www/nursery-system/app.js --name nursery-system;
            pm2 save;
            pm2 list
          "

      - name: 🧪 Health Check
        run: |
          echo "Checking app health..."
          ssh -i ~/.ssh/id_rsa "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" "
            curl -f http://localhost:3000/api/health || exit 1
          "
          echo "✅ Health check passed!"

      - name: 🔍 Deployment Summary
        run: |
          echo "=== Deployment Diagnostics ==="
          node -v
          npm -v
          ssh -i ~/.ssh/id_rsa "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" "pm2 describe nursery-system"
          echo "=== End of Diagnostics ==="
