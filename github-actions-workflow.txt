name: Node.js CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # ğŸ›ï¸ Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯
      - name: Checkout code
        uses: actions/checkout@v4

      # ğŸ› ï¸ ØªØ«Ø¨ÙŠØª Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª
      - name: Install dependencies
        run: npm install

      # âœ… ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      - name: Check DB connection
        run: npm run db:check

      # â™»ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      - name: Reset DB
        run: npm run db:reset

      # ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
      - name: Start server
        run: |
          nohup npm start &
          sleep 5

      # ğŸ” Ø§Ø®ØªØ¨Ø§Ø± /api/health
      - name: Test /api/health endpoint
        run: |
          curl -f http://localhost:3000/api/health | grep '"status":"ok"'

      # ğŸ” Ø§Ø®ØªØ¨Ø§Ø± /api/performance/health
      - name: Test /api/performance/health endpoint
        run: |
          curl -f http://localhost:3000/api/performance/health | grep '"status":"ok"'

      # â™»ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
      - name: Reset DB during runtime
        run: npm run db:reset

      # ğŸ” Ø¥Ø¹Ø§Ø¯Ø© ÙØ­Øµ /api/health Ø¨Ø¹Ø¯ reset Ù„Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø³Ù„ÙŠÙ…
      - name: Re-test /api/health after DB reset
        run: |
          curl -f http://localhost:3000/api/health | grep '"status":"ok"'